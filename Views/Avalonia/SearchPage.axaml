<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:views="clr-namespace:SLSKDONET.Views.Avalonia"
             xmlns:controls="clr-namespace:SLSKDONET.Views.Avalonia.Controls"
             xmlns:models="clr-namespace:SLSKDONET.Models"
             mc:Ignorable="d" d:DesignWidth="1200" d:DesignHeight="800"
             x:Class="SLSKDONET.Views.Avalonia.SearchPage"
             Background="#1E1E1E" Foreground="White">
    
    <DockPanel>
        
        <!-- ZONE A: The Initiator (Top Bar) -->
        <Border DockPanel.Dock="Top" Background="#252526" BorderBrush="#3E3E3E" BorderThickness="0,0,0,1" Padding="16">
            <StackPanel Spacing="16">
                <!-- Search Input Row -->
                <Grid ColumnDefinitions="*,Auto,Auto,Auto">
                    <!-- Search Box -->
                    <Border Grid.Column="0" Background="#1E1E1E" CornerRadius="8" BorderBrush="#333" BorderThickness="1" Padding="4">
                        <Grid ColumnDefinitions="Auto,*,Auto">
                            <TextBlock Text="ðŸ”" VerticalAlignment="Center" Margin="8,0,0,0" Foreground="#888"/>
                            <TextBox Text="{Binding SearchQuery, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                     Watermark="Search for tracks, artists..."
                                     Background="Transparent" BorderThickness="0"
                                     FontSize="16" VerticalContentAlignment="Center" Margin="4,0"/>
                            <Button Command="{Binding ClearSearchCommand}" Background="Transparent" BorderThickness="0" 
                                    IsVisible="{Binding CanSearch}" Margin="0,0,4,0">
                                <TextBlock Text="âœ•" Foreground="#888"/>
                            </Button>
                        </Grid>
                    </Border>
                    
                    <!-- CSV/Paste Buttons -->
                    <StackPanel Grid.Column="1" Orientation="Horizontal" Margin="12,0,0,0" Spacing="8">
                        <Button Command="{Binding BrowseCsvCommand}" Classes="secondary" ToolTip.Tip="Import CSV">
                            <TextBlock Text="ðŸ“‚ CSV"/>
                        </Button>
                        <Button Command="{Binding PasteTracklistCommand}" Classes="secondary" ToolTip.Tip="Paste Tracklist">
                            <TextBlock Text="ðŸ“‹ Paste"/>
                        </Button>
                    </StackPanel>
                    
                    <!-- Search Button -->
                    <Button Grid.Column="2" Command="{Binding UnifiedSearchCommand}" Classes="primary" Margin="12,0,0,0" Padding="20,0" Height="40">
                        <StackPanel Orientation="Horizontal" Spacing="8">
                            <TextBlock Text="SEARCH"/>
                            <TextBlock Text="âž¡ï¸"/>
                        </StackPanel>
                    </Button>
                </Grid>
                
                <!-- Presets Row -->
                <StackPanel Orientation="Horizontal" Spacing="12">
                    <TextBlock Text="Presets:" VerticalAlignment="Center" Foreground="#888" FontWeight="SemiBold"/>
                    <Button Command="{Binding ApplyPresetCommand}" CommandParameter="Deep Dive" Classes="pill" Content="ðŸŒŠ Deep Dive" ToolTip.Tip="Match Priority, low bitrate threshold"/>
                    <Button Command="{Binding ApplyPresetCommand}" CommandParameter="Quick Grab" Classes="pill" Content="âš¡ Quick Grab" ToolTip.Tip="Reliability &amp; Speed Priority"/>
                    <Button Command="{Binding ApplyPresetCommand}" CommandParameter="High Fidelity" Classes="pill" Content="ðŸ’Ž High Fidelity" ToolTip.Tip="Strict Quality, FLAC only"/>
                    <Button Command="{Binding ApplyPresetCommand}" CommandParameter="Balanced" Classes="pill" Content="âš–ï¸ Balanced" ToolTip.Tip="Reset to defaults"/>
                </StackPanel>
            </StackPanel>
        </Border>
        
        <!-- ZONE B: The Brain (Sidebar) -->
        <Border DockPanel.Dock="Left" Width="280" Background="#222" BorderBrush="#3E3E3E" BorderThickness="0,0,1,0" Padding="16">
            <StackPanel Spacing="24">
                <TextBlock Text="Ranking Logic" FontSize="18" FontWeight="Bold" Foreground="#DDD"/>
                
                <!-- Bitrate Weight -->
                <StackPanel Spacing="8">
                     <Grid ColumnDefinitions="*,Auto">
                         <TextBlock Text="Bitrate (Quality)" Foreground="#AAA"/>
                         <TextBlock Text="{Binding BitrateWeight, StringFormat='x{0:F1}'}" Foreground="#4EC9B0"/>
                     </Grid>
                     <Slider Value="{Binding BitrateWeight}" Minimum="0" Maximum="5" TickFrequency="0.5" IsSnapToTickEnabled="True"/>
                </StackPanel>
                
                <!-- Reliability Weight -->
                <StackPanel Spacing="8">
                     <Grid ColumnDefinitions="*,Auto">
                         <TextBlock Text="Reliability (Slots)" Foreground="#AAA"/>
                         <TextBlock Text="{Binding ReliabilityWeight, StringFormat='x{0:F1}'}" Foreground="#007ACC"/>
                     </Grid>
                     <Slider Value="{Binding ReliabilityWeight}" Minimum="0" Maximum="5" TickFrequency="0.5" IsSnapToTickEnabled="True"/>
                </StackPanel>
                
                <!-- Match Weight -->
                <StackPanel Spacing="8">
                     <Grid ColumnDefinitions="*,Auto">
                         <TextBlock Text="Match Accuracy" Foreground="#AAA"/>
                         <TextBlock Text="{Binding MatchWeight, StringFormat='x{0:F1}'}" Foreground="#DCDCAA"/>
                     </Grid>
                     <Slider Value="{Binding MatchWeight}" Minimum="0" Maximum="5" TickFrequency="0.5" IsSnapToTickEnabled="True"/>
                </StackPanel>
                
                <Separator Background="#333" Height="1"/>
                
                <!-- Stats / Debug -->
                <StackPanel Spacing="8">
                    <TextBlock Text="Status" FontWeight="SemiBold" Foreground="#888"/>
                    <TextBlock Text="{Binding StatusText}" TextWrapping="Wrap" Foreground="White"/>
                    <TextBlock Text="{Binding SearchResults.Count, StringFormat='Visible: {0}'}" Foreground="#888"/>
                    <TextBlock Text="{Binding HiddenResultsCount, StringFormat='Hidden: {0}'}" Foreground="#666" FontSize="11"/>
                </StackPanel>
                
            </StackPanel>
        </Border>
        
        <!-- ZONE C: Gatekeeper & Results (Main Content) -->
        <Grid RowDefinitions="Auto,*">
            
            <!-- Filters & Toggles -->
            <Border Grid.Row="0" Background="#1E1E1E" Padding="16,12" BorderBrush="#333" BorderThickness="0,0,0,1">
                <Grid ColumnDefinitions="Auto,*,Auto">
                    <!-- Format Toggles -->
                    <StackPanel Grid.Column="0" Orientation="Horizontal" Spacing="8">
                        <TextBlock Text="Formats:" VerticalAlignment="Center" Foreground="#888" Margin="0,0,8,0"/>
                        <ToggleButton IsChecked="{Binding IsMp3Enabled}" Content="MP3" CornerRadius="4"/>
                        <ToggleButton IsChecked="{Binding IsFlacEnabled}" Content="FLAC" CornerRadius="4"/>
                        <ToggleButton IsChecked="{Binding IsWavEnabled}" Content="WAV" CornerRadius="4"/>
                    </StackPanel>
                    
                    <!-- Safety Toggle -->
                    <StackPanel Grid.Column="2" Orientation="Horizontal" Spacing="16">
                         <ToggleSwitch IsChecked="{Binding FilterViewModel.HideSuspects}" OnContent="Safety On" OffContent="Safety Off" ToolTip.Tip="Filter out potential fake/upscaled files"/>
                         
                         <!-- Add to Downloads Button -->
                         <Button Command="{Binding AddToDownloadsCommand}" IsEnabled="{Binding !!SelectedTrackCount}" Classes="primary" Padding="16,6">
                             <StackPanel Orientation="Horizontal" Spacing="6">
                                 <TextBlock Text="â¬‡ï¸"/>
                                 <TextBlock Text="{Binding SelectedTrackCount, StringFormat='Download ({0})'}" />
                             </StackPanel>
                         </Button>
                    </StackPanel>
                </Grid>
            </Border>
            
            <!-- Results DataGrid -->
            <DataGrid Grid.Row="1" ItemsSource="{Binding SearchResults}"
                      AutoGenerateColumns="False" SelectionMode="Extended"
                      GridLinesVisibility="Horizontal" Background="Transparent" RowBackground="Transparent"
                      CanUserSortColumns="True" HeadersVisibility="Column"
                      Margin="16,0">
                
                <DataGrid.Styles>
                     <Style Selector="DataGridRow.golden">
                        <Setter Property="Background" Value="#1AFFD700"/>
                        <Setter Property="BorderBrush" Value="#FFD700"/>
                        <Setter Property="BorderThickness" Value="0,0,0,1"/>
                    </Style>
                </DataGrid.Styles>
                
                <DataGrid.Columns>
                    <!-- Integrity -->
                    <DataGridTemplateColumn Header=" " Width="30">
                        <DataGridTemplateColumn.CellTemplate>
                            <DataTemplate>
                                <TextBlock Text="{Binding IntegrityBadge}" ToolTip.Tip="{Binding IntegrityTooltip}" HorizontalAlignment="Center" VerticalAlignment="Center"/>
                            </DataTemplate>
                        </DataGridTemplateColumn.CellTemplate>
                    </DataGridTemplateColumn>
                    
                    <!-- Rank -->
                    <DataGridTemplateColumn Header="Rank" Width="60" SortMemberPath="CurrentRank">
                        <DataGridTemplateColumn.CellTemplate>
                            <DataTemplate>
                                <Border Background="{Binding RowBackground}" CornerRadius="4" Padding="4,2" HorizontalAlignment="Center" ToolTip.Tip="{Binding ScoreBreakdown}">
                                    <TextBlock Text="{Binding CurrentRank, StringFormat='{}{0:F1}'}" FontWeight="Bold"/>
                                </Border>
                            </DataTemplate>
                        </DataGridTemplateColumn.CellTemplate>
                    </DataGridTemplateColumn>
                    
                    <!-- Track Details (Multi-line) -->
                    <DataGridTemplateColumn Header="Track Details" Width="*" SortMemberPath="Title">
                         <DataGridTemplateColumn.CellTemplate>
                            <DataTemplate>
                                <StackPanel Margin="4" Opacity="{Binding HeatMapOpacity}">
                                    <TextBlock Text="{Binding PrimaryDisplay}" FontWeight="SemiBold" TextTrimming="CharacterEllipsis"/>
                                    <StackPanel Orientation="Horizontal" Spacing="6">
                                         <TextBlock Text="{Binding FileFormat}" Foreground="#4EC9B0" FontSize="11"/>
                                         <TextBlock Text="{Binding Bitrate, StringFormat='{}{0}kbps'}" Foreground="#AAA" FontSize="11"/>
                                         <TextBlock Text="â€¢" Foreground="#444"/>
                                         <TextBlock Text="{Binding Size, Converter={x:Static models:SizeConverter.Instance}}" Foreground="#888" FontSize="11"/>
                                         <TextBlock Text="â€¢" Foreground="#444"/>
                                         <TextBlock Text="{Binding Username}" Foreground="#007ACC" FontSize="11"/>
                                         <TextBlock Text="âœ“" Foreground="Green" IsVisible="{Binding HasFreeUploadSlot}" FontSize="11"/>
                                    </StackPanel>
                                </StackPanel>
                            </DataTemplate>
                         </DataGridTemplateColumn.CellTemplate>
                    </DataGridTemplateColumn>
                    
                    <!-- Status -->
                    <DataGridTextColumn Header="Status" Binding="{Binding StatusIcon}" Width="50"/>
                    
                </DataGrid.Columns>
                
                 <DataGrid.ContextMenu>
                    <ContextMenu>
                        <MenuItem Header="Download Selected" Command="{Binding DownloadSelectedCommand}"/>
                    </ContextMenu>
                </DataGrid.ContextMenu>
            </DataGrid>
            
            <!-- Empty State -->
            <StackPanel Grid.Row="1" VerticalAlignment="Center" HorizontalAlignment="Center" IsVisible="{Binding !SearchResults.Count}">
                 <TextBlock Text="Waiting for Signal..." Foreground="#444" FontSize="24" HorizontalAlignment="Center"/>
                 <TextBlock Text="Use the controls to initiate a search" Foreground="#333" HorizontalAlignment="Center"/>
            </StackPanel>
            
        </Grid>
        
    </DockPanel>
    
    <UserControl.Styles>
        <Style Selector="Button.pill">
            <Setter Property="CornerRadius" Value="16"/>
            <Setter Property="Padding" Value="12,6"/>
            <Setter Property="Background" Value="#333"/>
            <Setter Property="Foreground" Value="#DDD"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="BorderBrush" Value="#444"/>
        </Style>
        <Style Selector="Button.pill:pointerover">
            <Setter Property="Background" Value="#444"/>
            <Setter Property="BorderBrush" Value="#666"/>
        </Style>
         <Style Selector="ToggleButton">
            <Setter Property="Background" Value="#333"/>
            <Setter Property="Foreground" Value="#AAA"/>
             <Setter Property="Padding" Value="12,6"/>
        </Style>
        <Style Selector="ToggleButton:checked">
             <Setter Property="Background" Value="#0078D4"/>
             <Setter Property="Foreground" Value="White"/>
        </Style>
    </UserControl.Styles>
</UserControl>
