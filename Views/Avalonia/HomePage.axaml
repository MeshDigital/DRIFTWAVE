<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:vm="clr-namespace:SLSKDONET.ViewModels"
             xmlns:conv="clr-namespace:SLSKDONET.Converters"
             mc:Ignorable="d" d:DesignWidth="1200" d:DesignHeight="1000"
             x:Class="SLSKDONET.Views.Avalonia.HomePage"
             x:DataType="vm:HomeViewModel"
             Background="#0A0A0B">
    
    <UserControl.Styles>
        <Style Selector="Border.glass">
            <Setter Property="Background" Value="#1A1A1D"/>
            <Setter Property="BorderBrush" Value="#2A2A2E"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="CornerRadius" Value="16"/>
            <Setter Property="Opacity" Value="0.95"/>
            <Setter Property="BoxShadow" Value="0 4 24 0 #08000000"/>
        </Style>
        <Style Selector="Border.glass:pointerover">
            <Setter Property="BorderBrush" Value="#404045"/>
            <Setter Property="Background" Value="#222226"/>
        </Style>
    </UserControl.Styles>

    <Grid RowDefinitions="Auto,*" Margin="32">
        <!-- Header -->
        <Grid Grid.Row="0" ColumnDefinitions="*,Auto" Margin="0,0,0,32">
            <StackPanel Grid.Column="0">
                <TextBlock Text="Mission Control" FontSize="32" FontWeight="Black" Foreground="White" LetterSpacing="-0.5"/>
                <TextBlock Text="System Status &amp; Intelligence Dashboard" FontSize="14" Foreground="#808080" Margin="0,4,0,0"/>
            </StackPanel>
            
            <Button Grid.Column="1" Command="{Binding RefreshDashboardCommand}" 
                    Background="Transparent" BorderThickness="0" Padding="8" VerticalAlignment="Top">
                <TextBlock Text="ðŸ”„ Refresh" Foreground="#00A3FF" FontSize="13" FontWeight="SemiBold"/>
            </Button>
        </Grid>
        
        <ScrollViewer Grid.Row="1">
            <StackPanel Spacing="24">
                <!-- Top Bento Row: Core Metrics -->
                <Grid ColumnDefinitions="2*,2*,1.5*" RowDefinitions="180">
                    <!-- Library Health Tile -->
                    <Border Grid.Column="0" Classes="glass" Padding="24" Margin="0,0,16,0">
                        <Grid ColumnDefinitions="*,Auto">
                            <Grid Grid.Column="0" RowDefinitions="Auto,*,Auto">
                                <TextBlock Grid.Row="0" Text="LIBRARY PURITY" FontSize="11" FontWeight="Bold" Foreground="#606060" LetterSpacing="1"/>
                                
                                <StackPanel Grid.Row="1" VerticalAlignment="Center" Spacing="0">
                                    <StackPanel Orientation="Horizontal" VerticalAlignment="Bottom">
                                        <TextBlock Text="{Binding PurityPercent, StringFormat='{}{0:F0}'}" FontSize="48" FontWeight="Black" Foreground="White"/>
                                        <TextBlock Text="%" FontSize="24" FontWeight="Bold" Foreground="#1DB954" Margin="4,0,0,10" VerticalAlignment="Bottom"/>
                                    </StackPanel>
                                    <TextBlock Text="{Binding PurityStatus}" FontSize="13" Foreground="#A0A0A0" FontWeight="SemiBold"/>
                                </StackPanel>
                                
                                <StackPanel Grid.Row="2" Orientation="Horizontal" Spacing="8">
                                    <Border Background="#1A00A3FF" CornerRadius="6" Padding="8,4" ToolTip.Tip="Gold (FLAC/WAV)">
                                        <TextBlock Text="{Binding LibraryHealth.GoldCount, StringFormat='{}{0} ðŸ†', FallbackValue='0'}" 
                                                   FontSize="11" Foreground="#00A3FF" FontWeight="Bold"/>
                                    </Border>
                                    <Border Background="#1A1DB954" CornerRadius="6" Padding="8,4" ToolTip.Tip="Silver (320kbps)">
                                        <TextBlock Text="{Binding LibraryHealth.SilverCount, StringFormat='{}{0} ðŸ¥ˆ', FallbackValue='0'}" 
                                                   FontSize="11" Foreground="#1DB954" FontWeight="Bold"/>
                                    </Border>
                                    <Border Background="#1AFF6B6B" CornerRadius="6" Padding="8,4" ToolTip.Tip="Bronze (Low Quality)">
                                        <TextBlock Text="{Binding LibraryHealth.BronzeCount, StringFormat='{}{0} ðŸ¥‰', FallbackValue='0'}" 
                                                   FontSize="11" Foreground="#FF6B6B" FontWeight="Bold"/>
                                    </Border>
                                </StackPanel>
                            </Grid>
                        </Grid>
                    </Border>
                    
                    <!-- Active Missions (Air Traffic Control) Widget -->
                    <Border Grid.Column="1" Classes="glass" Padding="20" Margin="0,0,16,0">
                        <Grid RowDefinitions="Auto,*,Auto">
                            <Grid Grid.Row="0" ColumnDefinitions="*,Auto">
                                <TextBlock Text="ACTIVE MISSIONS" FontSize="11" FontWeight="Bold" Foreground="#606060" LetterSpacing="1"/>
                                <TextBlock Text="{Binding DownloadSpeed, StringFormat='{}â¬‡ {0}'}" FontSize="11" Foreground="#00BCD4" FontWeight="Bold" Grid.Column="1"/>
                            </Grid>
                            
                            <StackPanel Grid.Row="1" VerticalAlignment="Center" Spacing="12">
                                <!-- Express Lane -->
                                <Grid ColumnDefinitions="Auto,*,Auto">
                                    <TextBlock Text="ðŸš€ Express" FontSize="13" Foreground="#FFCA28" FontWeight="Bold" Width="80"/>
                                    <ProgressBar Grid.Column="1" Value="{Binding ExpressCount}" Maximum="10" Height="4" Background="#333" Foreground="#FFCA28" CornerRadius="2" Margin="0,0,12,0" VerticalAlignment="Center"/>
                                    <TextBlock Grid.Column="2" Text="{Binding ExpressCount}" FontSize="13" Foreground="White" FontWeight="Bold"/>
                                </Grid>
                                
                                <!-- Standard Lane -->
                                <Grid ColumnDefinitions="Auto,*,Auto">
                                    <TextBlock Text="ðŸ“¦ Standard" FontSize="13" Foreground="#2196F3" FontWeight="SemiBold" Width="80"/>
                                    <ProgressBar Grid.Column="1" Value="{Binding StandardCount}" Maximum="50" Height="4" Background="#333" Foreground="#2196F3" CornerRadius="2" Margin="0,0,12,0" VerticalAlignment="Center"/>
                                    <TextBlock Grid.Column="2" Text="{Binding StandardCount}" FontSize="13" Foreground="#DDD" FontWeight="SemiBold"/>
                                </Grid>
                                
                                <!-- Background Lane -->
                                <Grid ColumnDefinitions="Auto,*,Auto">
                                    <TextBlock Text="ðŸŒ™ Background" FontSize="13" Foreground="#AAA" Width="80"/>
                                    <ProgressBar Grid.Column="1" Value="{Binding BackgroundCount}" Maximum="200" Height="4" Background="#333" Foreground="#666" CornerRadius="2" Margin="0,0,12,0" VerticalAlignment="Center"/>
                                    <TextBlock Grid.Column="2" Text="{Binding BackgroundCount}" FontSize="13" Foreground="#AAA"/>
                                </Grid>
                            </StackPanel>
                            
                            <TextBlock Grid.Row="2" Text="Air Traffic Control Active" FontSize="10" Foreground="#555" FontStyle="Italic" HorizontalAlignment="Center"/>
                        </Grid>
                    </Border>
                    
                    <!-- System Health (Dead Letter) Widget -->
                    <Border Grid.Column="2" Classes="glass" Padding="20">
                        <Grid RowDefinitions="Auto,*,Auto">
                            <TextBlock Grid.Row="0" Text="SYSTEM HEALTH" FontSize="11" FontWeight="Bold" Foreground="#606060" LetterSpacing="1"/>
                            
                            <StackPanel Grid.Row="1" VerticalAlignment="Center" Spacing="16" HorizontalAlignment="Center">
                                <!-- Blinking LED Indicator -->
                                <Border Width="32" Height="32" CornerRadius="16" Background="{Binding HealthColor, Converter={x:Static conv:StringToBrushConverter.Instance}}">
                                    <Border.Styles>
                                        <Style Selector="Border">
                                            <Style.Animations>
                                                <Animation Duration="0:0:2" IterationCount="Infinite">
                                                    <KeyFrame Cue="0%">
                                                        <Setter Property="Opacity" Value="0.6"/>
                                                        <Setter Property="BoxShadow" Value="0 0 10 2 #40FFFFFF"/>
                                                    </KeyFrame>
                                                    <KeyFrame Cue="50%">
                                                        <Setter Property="Opacity" Value="1.0"/>
                                                        <Setter Property="BoxShadow" Value="0 0 20 5 #80FFFFFF"/>
                                                    </KeyFrame>
                                                    <KeyFrame Cue="100%">
                                                        <Setter Property="Opacity" Value="0.6"/>
                                                        <Setter Property="BoxShadow" Value="0 0 10 2 #40FFFFFF"/>
                                                    </KeyFrame>
                                                </Animation>
                                            </Style.Animations>
                                        </Style>
                                    </Border.Styles>
                                    <!-- Inner Core -->
                                    <Border Width="12" Height="12" CornerRadius="6" Background="White" Opacity="0.8" HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                </Border>
                                
                                <StackPanel Spacing="4">
                                    <TextBlock Text="{Binding LibraryHealth.HealthStatus}" FontSize="14" FontWeight="Bold" Foreground="White" HorizontalAlignment="Center" TextAlignment="Center"/>
                                    <TextBlock Text="{Binding CurrentSnapshot.ZombieProcessCount, StringFormat='{}Zombie Processes: {0}'}" 
                                               FontSize="10" Foreground="#808080" HorizontalAlignment="Center"
                                               IsVisible="{Binding CurrentSnapshot.ZombieProcessCount, Converter={x:Static ObjectConverters.NotEqual}, ConverterParameter=0}"/>
                                </StackPanel>
                            </StackPanel>
                            
                            <Button Grid.Row="2" Command="{Binding ClearDeadLettersCommand}" 
                                    IsVisible="{Binding LibraryHealth.IssuesCount, Converter={x:Static ObjectConverters.NotEqual}, ConverterParameter=0}"
                                    Background="#2A1010" BorderBrush="#FF5252" BorderThickness="1" CornerRadius="4" HorizontalAlignment="Center" Padding="12,4">
                                <TextBlock Text="Auto-Recover" Foreground="#FF5252" FontSize="11" FontWeight="Bold"/>
                            </Button>
                        </Grid>
                    </Border>
                </Grid>

                <!-- Phase 0A: Live Operations & Resilience Log -->
                <Grid ColumnDefinitions="2*,1*" Margin="0,0,0,8">
                    <!-- Live Operations Feed -->
                    <Border Grid.Column="0" Classes="glass" Padding="20" Margin="0,0,16,0">
                        <Grid RowDefinitions="Auto,*">
                            <Grid Grid.Row="0" ColumnDefinitions="*,Auto" Margin="0,0,0,12">
                                <TextBlock Text="LIVE OPERATIONS FEED" FontSize="11" FontWeight="Bold" Foreground="#606060" LetterSpacing="1"/>
                                <StackPanel Orientation="Horizontal" Grid.Column="1" Spacing="8">
                                    <Border Background="#222" CornerRadius="4" Padding="6,2">
                                        <TextBlock Text="{Binding CurrentSnapshot.ActiveDownloads, StringFormat='{}â¬‡ {0}'}" FontSize="10" Foreground="#00BCD4" FontWeight="Bold"/>
                                    </Border>
                                    <Border Background="#222" CornerRadius="4" Padding="6,2">
                                        <TextBlock Text="{Binding CurrentSnapshot.ZombieProcessCount, StringFormat='{}ðŸ§Ÿ {0}'}" FontSize="10" Foreground="#FF5252" FontWeight="Bold"/>
                                    </Border>
                                </StackPanel>
                            </Grid>
                            
                            <ScrollViewer Grid.Row="1" Height="200">
                                <ItemsRepeater ItemsSource="{Binding ActiveOperations}">
                                    <ItemsRepeater.Layout>
                                        <StackLayout Orientation="Vertical" Spacing="4"/>
                                    </ItemsRepeater.Layout>
                                    <ItemsRepeater.ItemTemplate>
                                        <DataTemplate>
                                            <Border Background="#0DFFFFFF" CornerRadius="4" Padding="8,6">
                                                <TextBlock Text="{Binding}" Foreground="#DDD" FontSize="12" FontFamily="Consolas, Monospace"/>
                                            </Border>
                                        </DataTemplate>
                                    </ItemsRepeater.ItemTemplate>
                                </ItemsRepeater>
                            </ScrollViewer>
                        </Grid>
                    </Border>
                    
                    <!-- Resilience Log -->
                    <Border Grid.Column="1" Classes="glass" Padding="20">
                        <Grid RowDefinitions="Auto,*">
                            <TextBlock Grid.Row="0" Text="RESILIENCE LOG" FontSize="11" FontWeight="Bold" Foreground="#606060" LetterSpacing="1" Margin="0,0,0,12"/>
                            
                            <ScrollViewer Grid.Row="1" Height="200">
                                <ItemsRepeater ItemsSource="{Binding ResilienceLog}">
                                    <ItemsRepeater.Layout>
                                        <StackLayout Orientation="Vertical" Spacing="4"/>
                                    </ItemsRepeater.Layout>
                                    <ItemsRepeater.ItemTemplate>
                                        <DataTemplate>
                                            <Border Background="#0D00FF00" CornerRadius="4" Padding="8,6" BorderBrush="#00FF00" BorderThickness="0,0,0,0">
                                                <Grid ColumnDefinitions="Auto,*">
                                                    <TextBlock Text="ðŸ›¡ï¸" FontSize="10" Margin="0,0,8,0" VerticalAlignment="Center"/>
                                                    <TextBlock Grid.Column="1" Text="{Binding}" Foreground="#808080" FontSize="11" TextWrapping="Wrap" VerticalAlignment="Center"/>
                                                </Grid>
                                            </Border>
                                        </DataTemplate>
                                    </ItemsRepeater.ItemTemplate>
                                </ItemsRepeater>
                            </ScrollViewer>
                        </Grid>
                    </Border>
                </Grid>
                
                <!-- Second Row: Recently Added (Horizontal Scroller) -->
                <StackPanel Spacing="16">
                    <Grid ColumnDefinitions="*,Auto">
                        <TextBlock Text="Recently Added" FontSize="20" FontWeight="Bold" Foreground="White"/>
                        <Button Grid.Column="1" Background="Transparent" Command="{Binding NavigateLibraryCommand}">
                            <TextBlock Text="View All â†’" Foreground="#808080" FontSize="13"/>
                        </Button>
                    </Grid>
                    
                    <ItemsControl ItemsSource="{Binding RecentPlaylists}">
                        <ItemsControl.ItemsPanel>
                            <ItemsPanelTemplate>
                                <StackPanel Orientation="Horizontal" Spacing="16"/>
                            </ItemsPanelTemplate>
                        </ItemsControl.ItemsPanel>
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <!-- Using a compact card for dashboard -->
                                <Border Width="180" Background="#121214" CornerRadius="12" Padding="12" BorderBrush="#1F1F23" BorderThickness="1">
                                    <StackPanel Spacing="8">
                                        <Border CornerRadius="8" ClipToBounds="True" Background="#262629">
                                            <Rectangle Fill="#1A1A1D" Height="156"/>
                                        </Border>
                                        <TextBlock Text="{Binding Name}" FontWeight="SemiBold" FontSize="13" TextTrimming="CharacterEllipsis"/>
                                        <TextBlock Text="{Binding SuccessfulCount, StringFormat='{}{0} tracks'}" FontSize="11" Foreground="#808080"/>
                                    </StackPanel>
                                </Border>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                </StackPanel>
                
                <!-- Third Row: Spotify Recommendations -->
                <StackPanel Spacing="16">
                    <TextBlock Text="Recommended for You" FontSize="20" FontWeight="Bold" Foreground="White"/>
                    
                    <ItemsControl ItemsSource="{Binding SpotifyRecommendations}">
                        <ItemsControl.ItemsPanel>
                            <ItemsPanelTemplate>
                                <UniformGrid Columns="4" Rows="2" />
                            </ItemsPanelTemplate>
                        </ItemsControl.ItemsPanel>
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <Border Grid.ColumnSpan="1" Margin="0,0,16,16" Background="#121214" CornerRadius="12" Padding="12" BorderBrush="#1F1F23" BorderThickness="1">
                                    <Grid ColumnDefinitions="48,*,Auto">
                                        <Border Grid.Column="0" CornerRadius="6" ClipToBounds="True" Width="48" Height="48">
                                            <!-- We would ideally use an AsyncImage control here, for now placeholder -->
                                            <Rectangle Fill="#262629"/>
                                        </Border>
                                        
                                        <StackPanel Grid.Column="1" VerticalAlignment="Center">
                                            <TextBlock Text="{Binding Title}" FontWeight="SemiBold" FontSize="13" TextTrimming="CharacterEllipsis"/>
                                            <TextBlock Text="{Binding Artist}" FontSize="11" Foreground="#808080" TextTrimming="CharacterEllipsis"/>
                                        </StackPanel>
                                        
                                        <StackPanel Grid.Column="2" VerticalAlignment="Center" Spacing="4">
                                            <Button Command="{Binding ((vm:HomeViewModel)DataContext).QuickSearchCommand, RelativeSource={RelativeSource AncestorType=UserControl}}" 
                                                    CommandParameter="{Binding}"
                                                    Padding="6" Background="#1DB954" CornerRadius="4">
                                                <TextBlock Text="ðŸ”" FontSize="12"/>
                                            </Button>
                                            <TextBlock IsVisible="{Binding InLibrary}" Text="âœ¨ In Library" FontSize="9" Foreground="#1DB954" FontWeight="Bold" HorizontalAlignment="Right"/>
                                        </StackPanel>
                                    </Grid>
                                </Border>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                </StackPanel>
            </StackPanel>
        </ScrollViewer>
    </Grid>
</UserControl>
